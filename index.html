<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Thêm dòng này để ứng dụng trông như app thật khi thêm vào màn hình chính -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>AI Newsfeed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Bỏ highlight khi nhấn trên mobile */
        }
        /* Style cho thanh cuộn */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Animation cho loading spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto max-w-3xl">
        <header class="sticky top-0 bg-gray-50/80 backdrop-blur-sm z-10 p-4 border-b border-gray-200">
            <h1 class="text-2xl font-bold text-center text-gray-900">AI Newsfeed</h1>
            <p class="text-center text-gray-500 text-sm mt-1">Tin tức mới nhất về Trí tuệ Nhân tạo từ GNews</p>
        </header>

        <main class="p-4">
            <!-- Nút điều khiển -->
            <div class="flex justify-center space-x-2 mb-6">
                <button id="fetch-news-btn" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-indigo-700 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                    Tải Tin Mới
                </button>
                <button id="export-btn" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-green-700 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                    Xuất File
                </button>
            </div>
            
            <!-- Khu vực hiển thị thông báo và loading -->
            <div id="status-container" class="text-center my-4 min-h-[40px] flex justify-center items-center"></div>

            <!-- Khu vực hiển thị tin tức -->
            <div id="news-container" class="space-y-4">
                <!-- Tin tức sẽ được chèn vào đây bằng JavaScript -->
            </div>
            
            <hr class="my-8 border-gray-300">
            
            <!-- Khu vực hiển thị tin đã lưu -->
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Tin Đã Lưu</h2>
                    <button id="clear-storage-btn" class="text-sm text-red-500 hover:text-red-700 hover:underline">
                        Xóa tất cả
                    </button>
                </div>
                <div id="saved-news-container" class="space-y-3"></div>
            </div>
        </main>
    </div>

    <script>
        // --- CẤU HÌNH ---
        // Đã cập nhật API Key của bạn
        const API_KEY = 'ce5b7ab27d752fc4a4f73e8f3a78e99b';
        const keywords = '"trí tuệ nhân tạo" OR "AI"';
        // Đổi sang dùng GNews API
        const NEWS_API_URL = `https://gnews.io/api/v4/search?q=${encodeURIComponent(keywords)}&lang=vi&country=vn&max=20&apikey=${API_KEY}`;

        // --- LẤY CÁC THÀNH PHẦN GIAO DIỆN ---
        const fetchNewsBtn = document.getElementById('fetch-news-btn');
        const exportBtn = document.getElementById('export-btn');
        const clearStorageBtn = document.getElementById('clear-storage-btn');
        const newsContainer = document.getElementById('news-container');
        const savedNewsContainer = document.getElementById('saved-news-container');
        const statusContainer = document.getElementById('status-container');

        // --- LOGIC ỨNG DỤNG ---

        function showStatus(type, message = '') {
            if (type === 'loading') {
                statusContainer.innerHTML = '<div class="spinner"></div>';
            } else if (type === 'message') {
                statusContainer.innerHTML = `<p class="text-gray-500">${message}</p>`;
            } else if (type === 'error') {
                 statusContainer.innerHTML = `<p class="text-red-500 font-semibold">${message}</p>`;
            } else {
                statusContainer.innerHTML = '';
            }
        }

        async function fetchNews() {
            showStatus('loading');
            newsContainer.innerHTML = ''; 
            if (!API_KEY || API_KEY === 'YOUR_API_KEY') {
                showStatus('error', 'Lỗi: Vui lòng cung cấp API Key từ GNews.io trong file code.');
                return;
            }
            try {
                const response = await fetch(NEWS_API_URL);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.errors.join(', '));
                }
                const data = await response.json();
                
                if (data.articles && data.articles.length > 0) {
                    displayNews(data.articles);
                    showStatus('message', `Đã tìm thấy ${data.articles.length} tin mới.`);
                } else {
                    showStatus('message', 'Không tìm thấy tin tức nào phù hợp.');
                }
            } catch (error) {
                console.error('Lỗi khi tải tin:', error);
                showStatus('error', `Không thể tải tin tức. Lỗi: ${error.message}`);
            }
        }

        function displayNews(articles) {
            articles.forEach(article => {
                const articleEl = document.createElement('div');
                articleEl.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200 transform hover:-translate-y-1 transition-transform duration-300';
                
                // Cập nhật để lấy ảnh từ GNews (article.image)
                const imageUrl = article.image || `https://placehold.co/600x400/e2e8f0/4a5568?text=No+Image`;

                articleEl.innerHTML = `
                    <img src="${imageUrl}" alt="Article Image" class="rounded-lg mb-4 w-full h-48 object-cover bg-gray-200" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/4a5568?text=Image+Error';">
                    <h3 class="font-bold text-lg mb-1">${article.title}</h3>
                    <p class="text-gray-500 text-xs mb-2">Nguồn: ${article.source.name} - ${new Date(article.publishedAt).toLocaleDateString('vi-VN')}</p>
                    <p class="text-gray-600 text-sm mb-3">${article.description || 'Không có mô tả.'}</p>
                    <div class="flex justify-between items-center">
                        <a href="${article.url}" target="_blank" class="text-indigo-600 hover:underline text-sm font-semibold">Đọc thêm &rarr;</a>
                        <div class="rating-buttons">
                            <span class="text-sm font-medium mr-2">Đánh giá:</span>
                            <button data-title="${encodeURIComponent(article.title)}" data-url="${article.url}" data-rating="6" class="rate-btn bg-yellow-400 text-yellow-900 w-8 h-8 text-sm font-bold rounded-full hover:bg-yellow-500 transition-colors">6</button>
                            <button data-title="${encodeURIComponent(article.title)}" data-url="${article.url}" data-rating="8" class="rate-btn ml-1 bg-orange-500 text-white w-8 h-8 text-sm font-bold rounded-full hover:bg-orange-600 transition-colors">8</button>
                        </div>
                    </div>
                `;
                newsContainer.appendChild(articleEl);
            });
        }

        function saveNews(title, url, rating) {
            const savedNews = JSON.parse(localStorage.getItem('savedNewsAI') || '[]');
            // Sử dụng decodeURIComponent để lưu tiêu đề chính xác
            savedNews.unshift({ title: decodeURIComponent(title), url, rating, date: new Date().toLocaleString('vi-VN') });
            localStorage.setItem('savedNewsAI', JSON.stringify(savedNews));
            showStatus('message', `Đã lưu tin.`);
            loadSavedNews(); 
        }
        
        function loadSavedNews() {
            const savedNews = JSON.parse(localStorage.getItem('savedNewsAI') || '[]');
            savedNewsContainer.innerHTML = '';
            if (savedNews.length === 0) {
                 savedNewsContainer.innerHTML = '<p class="text-gray-400 text-center text-sm">Chưa có tin nào được lưu.</p>';
                 return;
            }
            savedNews.forEach(item => {
                const savedItemEl = document.createElement('div');
                savedItemEl.className = 'bg-white p-3 rounded-lg shadow-sm border border-gray-200';
                savedItemEl.innerHTML = `
                    <p class="font-semibold text-sm">${item.title}</p>
                    <p class="text-xs text-gray-500 mt-1">Đánh giá: <span class="font-bold text-black">${item.rating}</span> - Lưu lúc: ${item.date}</p>
                `;
                savedNewsContainer.appendChild(savedItemEl);
            });
        }

        function exportData() {
            const savedNews = JSON.parse(localStorage.getItem('savedNewsAI') || '[]');
            if (savedNews.length === 0) {
                showStatus('error', 'Không có dữ liệu để xuất.');
                return;
            }
            let textContent = 'DANH SÁCH TIN TỨC AI ĐÃ LƯU\n\n';
            savedNews.forEach(item => {
                textContent += `----------------------------------------\n`;
                textContent += `Tiêu đề: ${item.title}\n`;
                textContent += `Link: ${item.url}\n`;
                textContent += `Đánh giá: ${item.rating}\n`;
                textContent += `Ngày lưu: ${item.date}\n`;
                textContent += `----------------------------------------\n\n`;
            });

            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tin_tuc_ai_da_luu.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showStatus('message', 'Đã xuất file thành công!');
        }
        
        function clearStorage() {
            const savedNews = JSON.parse(localStorage.getItem('savedNewsAI') || '[]');
            if (savedNews.length > 0 && confirm('Bạn có chắc chắn muốn xóa tất cả tin tức đã lưu không?')) {
                localStorage.removeItem('savedNewsAI');
                loadSavedNews();
                showStatus('message', 'Đã xóa toàn bộ tin đã lưu.');
            }
        }

        // --- GÁN SỰ KIỆN ---
        fetchNewsBtn.addEventListener('click', fetchNews);
        exportBtn.addEventListener('click', exportData);
        clearStorageBtn.addEventListener('click', clearStorage);

        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('rate-btn')) {
                const button = e.target;
                const { title, url, rating } = button.dataset;
                saveNews(title, url, rating);
                
                const parentRatingDiv = button.closest('.rating-buttons');
                parentRatingDiv.innerHTML = '<span class="text-sm font-semibold text-green-600">Đã lưu ✔</span>';
            }
        });
        
        window.onload = () => {
            loadSavedNews();
            fetchNews();
        };

    </script>
</body>
</html>
